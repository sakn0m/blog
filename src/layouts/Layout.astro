---
import { ClientRouter } from 'astro:transitions';
import type { TransitionDirectionalAnimations } from 'astro:transitions';
import ThemeToggle from '../components/ThemeToggle.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../lib/consts';
import '../styles/globals.css';

import fontCharterRegular from '../assets/fonts/charter-regular.woff2';
import fontCharterItalic from '../assets/fonts/charter-italic.woff2';
import fontCharterBold from '../assets/fonts/charter-bold.woff2';

interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  transition?: TransitionDirectionalAnimations;
  preloadAllFonts?: boolean;
}

const {
  title = SITE_TITLE,
  description = SITE_DESCRIPTION,
  ogImage,
  transition,
  preloadAllFonts = false,
} = Astro.props;
---

<!doctype html>
<html lang="en" class="h-full" style="--font-charter: 'Charter';">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    {ogImage && <meta property="og:image" content={ogImage} />}

    <!-- Preload primary font to prevent FOUT -->
    <link rel="preload" href={fontCharterRegular} as="font" type="font/woff2" crossorigin="anonymous" />
    {preloadAllFonts && (
      <link rel="preload" href={fontCharterItalic} as="font" type="font/woff2" crossorigin="anonymous" />
      <link rel="preload" href={fontCharterBold} as="font" type="font/woff2" crossorigin="anonymous" />
    )}

    <!-- Charter font -->
    <style>
      @font-face {
        font-family: 'Charter';
        src: url('../assets/fonts/charter-regular.woff2') format('woff2');
        font-weight: 400;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Charter';
        src: url('../assets/fonts/charter-italic.woff2') format('woff2');
        font-weight: 400;
        font-style: italic;
        font-display: swap;
      }
      @font-face {
        font-family: 'Charter';
        src: url('../assets/fonts/charter-bold.woff2') format('woff2');
        font-weight: 700;
        font-style: normal;
        font-display: swap;
      }
      @font-face {
        font-family: 'Charter';
        src: url('../assets/fonts/charter-bold-italic.woff2') format('woff2');
        font-weight: 700;
        font-style: italic;
        font-display: swap;
      }
    </style>

    <ClientRouter />

    <!-- Dark mode: apply before render to prevent flash -->
    <script is:inline>
      function applyTheme() {
        const stored = localStorage.getItem('theme');
        const docEl = document.documentElement;
        if (stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          docEl.classList.add('dark');
          docEl.style.colorScheme = 'dark';
        } else {
          docEl.classList.remove('dark');
          docEl.style.colorScheme = 'light';
        }
      }
      applyTheme();
      document.addEventListener('astro:after-swap', applyTheme);

      document.addEventListener('click', (e) => {
        const link = e.target.closest('a');
        if (link && link.href && link.hostname === location.hostname && link.target !== '_blank') {
          link.classList.add('is-navigating');
        }
      });
      document.addEventListener('touchcancel', () => {
        document.querySelectorAll('.is-navigating').forEach(el => el.classList.remove('is-navigating'));
      }, { passive: true });
      document.addEventListener('astro:after-swap', () => {
        document.querySelectorAll('.is-navigating').forEach(el => el.classList.remove('is-navigating'));
      });
    </script>

    <script>
      // Fire Astro navigation on touchend (before click) for zero-latency transitions on mobile
      import { navigate } from 'astro:transitions/client';

      let startX = 0;
      let startY = 0;

      document.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }, { passive: true });

      document.addEventListener('touchend', (e) => {
        const link = e.target.closest('a');
        if (!link || !link.href || link.hostname !== location.hostname || link.target === '_blank') return;

        const dx = Math.abs(e.changedTouches[0].clientX - startX);
        const dy = Math.abs(e.changedTouches[0].clientY - startY);

        // Only navigate on a tap, not a swipe or scroll
        if (dx < 8 && dy < 8) {
          e.preventDefault(); // block the subsequent click event
          link.classList.add('is-navigating');
          navigate(link.href);
        }
      }, { passive: false });
    </script>
  </head>
  <body class="font-serif">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-neutral-900 focus:text-white focus:rounded dark:focus:bg-neutral-100 dark:focus:text-neutral-900">Skip to content</a>
    <main id="main-content" class="max-w-[750px] mx-auto px-6 py-24 md:py-32 relative">
      <div class="absolute top-6 right-6 md:top-12 md:right-0">
        <ThemeToggle />
      </div>
      <div transition:name="content" transition:animate={transition || 'none'}>
        <slot />
      </div>
    </main>
  </body>
</html>
